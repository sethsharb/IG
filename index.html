<!doctype html>
<meta charset="utf-8">
<title>Instagram Grid (image + handle)</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
  :root { --gap:16px; }
  body{
    margin:24px;
    font:15px/1.5 -apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Helvetica,Arial,sans-serif;
    background:#fafafa; color:#222;
  }
  .topbar{ display:flex; align-items:center; gap:12px; flex-wrap:wrap; margin-bottom:12px; }
  .muted{ color:#666 }
  /* .masonry{ column-width:260px; column-gap:var(--gap); } */
  /* @media (max-width:900px){ .masonry{ column-width:200px; } } */
  /* @media (max-width:640px){ .masonry{ column-width:160px; } } */
  /* Masonry using CSS Grid with JS-calculated row spans (stable order) */
  .masonry{
    display:grid;
    grid-template-columns: repeat(4, 1fr); /* 4 columns on widest */
    /* grid-auto-rows: 8px;  */
    gap: var(--gap);
    align-items:start; /* prevent stretch */
  }
  /* 3 columns on medium screens */
  @media (max-width: 1100px){
    .masonry{ grid-template-columns: repeat(3, 1fr); }
  }
  /* 2 columns on small/mobile screens */
  @media (max-width: 700px){
    .masonry{ grid-template-columns: repeat(2, 1fr); }
  }
  .card{ break-inside:avoid; margin:0 0; background:#fff; border:1px solid #eee; border-radius:12px; overflow:hidden; box-shadow:0 1px 2px rgba(0,0,0,.04); }
  .thumb{ display:block; background:#eee; }
  .thumb img{ display:block; width:100%; height:auto; }
  .meta{ padding:8px 10px; font-size:14px; color:#555; display:flex; justify-content:space-between; align-items:center; gap:10px; }
  .meta a{ color:inherit; text-decoration:none; }
  .meta a:hover{ text-decoration:underline; }
  .count{ font-size:13px; color:#777; }
  .controls{ display:flex; align-items:center; gap:12px; }
  input[type="range"]{ width:180px; }
  .warn{ color:#b45; font-size:12px; }
</style>

<div class="topbar" style="display:none;">
  <div class="count" id="count">Loading…</div>
  <div class="controls">
    <label class="muted">Gap <input id="gap" type="range" min="8" max="28" value="16"></label>
  </div>
</div>

<div class="masonry" id="grid" aria-live="polite"></div>
<div id="notes" class="muted" style="margin-top:10px;"></div>

<script>
(async () => {
  // --- Masonry sizing helpers (stable order) ---
  function resizeCard(card){
    const grid = document.getElementById('grid');
    const styles = window.getComputedStyle(grid);
    const rowHeight = parseFloat(styles.getPropertyValue('grid-auto-rows')) || 8;
    const gap = parseFloat(getComputedStyle(document.documentElement).getPropertyValue('--gap')) || 16;
    const h = card.getBoundingClientRect().height;
    const span = Math.ceil((h + gap) / (rowHeight + gap));
    card.style.gridRowEnd = 'span ' + span;
  }
  function wireMasonryObservers(card){
    // Recalculate when content changes size
    const ro = new ResizeObserver(() => resizeCard(card));
    ro.observe(card);
    // Initial calc once images are loaded
    const img = card.querySelector('img');
    if (img) {
      if (img.complete) resizeCard(card);
      else img.addEventListener('load', () => resizeCard(card), { once:true });
      img.addEventListener('error', () => resizeCard(card), { once:true });
    } else {
      resizeCard(card);
    }
  }
  const el = id => document.getElementById(id);
  const COUNT = el('count'), GRID = el('grid'), GAP = el('gap'), NOTES = el('notes');

  GAP.oninput = () =>
    document.documentElement.style.setProperty('--gap', GAP.value + 'px');

  // Load the file (must be served over http(s), not file://)
  const res = await fetch('posts_with_handles.txt', { cache:'no-store' });
  if (!res.ok) { COUNT.textContent = 'Could not load posts_with_handles.txt'; return; }
  const text = await res.text();

  // Split lines; ignore empties
  const lines = text.split(/\r?\n/).map(s => s.trim()).filter(Boolean);

  const items = [];
  let withHandle = 0, withoutHandle = 0;

  for (const rawLine of lines) {
    // Normalize spaces and @ variants
    const line = rawLine
      .replace(/\u00A0/g, ' ')          // non-breaking space → space
      .replace(/[\ufe6a\uff20]/g, '@')  // fullwidth/small @ → normal @
      .replace(/\s+/g, ' ')
      .trim();

    // URL = first http(s) token
    const urlMatch = line.match(/https?:\/\/\S+/i);
    if (!urlMatch) { withoutHandle++; continue; }
    const url = urlMatch[0].split('?')[0].replace(/\/?$/, '/');

    // Handle = first @username anywhere on the line
    // (Instagram allows a–z, 0–9, dot, underscore; up to 30 chars)
    const hMatch = line.match(/@([A-Za-z0-9._]{1,30})/);
    const handle = hMatch ? hMatch[1] : '';

    if (handle) withHandle++; else withoutHandle++;

    // We only know the image trick for /p/ posts
    const pm = url.match(/instagram\.com\/(p)\/([^\/?#]+)/i);
    if (!pm) {
      // If you want to show text-only cards for reels/tv, we can add that later.
      continue;
    }
    const code = pm[2];
    const imgSrc = 'https://images.weserv.nl/?url=' +
      encodeURIComponent('instagram.com/p/' + code + '/media/?size=l') +
      '&n=-1';

    items.push({ url, handle, imgSrc });
  }

  COUNT.textContent = `Found ${items.length} posts (${withHandle} with handle, ${withoutHandle} without)`;
  if (withoutHandle && withHandle === 0) {
    NOTES.innerHTML = '<span class="warn">All entries appear to be missing a recognizable "@handle" token on each line. Make sure each line looks like:<br><code>https://www.instagram.com/p/XXXX/ @username</code></span>';
  }

  // Render grid
  const frag = document.createDocumentFragment();
  for (const it of items) {
    const card = document.createElement('div');
    card.className = 'card';

    const link = document.createElement('a');
    link.className = 'thumb';
    link.href = it.url;
    link.target = '_blank';
    link.rel = 'noopener';

    const img = document.createElement('img');
    img.loading = 'lazy';
    img.alt = '';
    img.src = it.imgSrc;
    img.onerror = () => { card.remove(); };
    link.appendChild(img);
    card.appendChild(link);

    const meta = document.createElement('div');
    meta.className = 'meta';

    const handleEl = document.createElement('a');
    handleEl.textContent = it.handle ? '@' + it.handle : '@unknown';
    handleEl.href = it.handle
      ? 'https://www.instagram.com/' + it.handle + '/'
      : it.url;
    handleEl.target = '_blank';
    handleEl.rel = 'noopener';

    const open = document.createElement('a');
    open.textContent = 'Open post ↗';
    open.href = it.url;
    open.target = '_blank';
    open.rel = 'noopener';

    meta.appendChild(handleEl);
    meta.appendChild(open);
    card.appendChild(meta);

    wireMasonryObservers(card);
    frag.appendChild(card);
  }

  GRID.appendChild(frag);
  // Final pass to ensure correct spans
  GRID.querySelectorAll('.card').forEach(resizeCard);
  window.addEventListener('resize', () => GRID.querySelectorAll('.card').forEach(resizeCard));
})();
</script>